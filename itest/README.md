## `network_test.pl`

### TL;DR

    # yum install perl-Test-Simple
	$ afina -p pidfile -d
	$ prove .../путь/к/itest.pl
	$ kill $(cat pidfile)

### Нельзя войти в одну реку более одного раза

Текущая версия парсера не поддерживает команду `delete`, так что тест не может проверить работу команды `add` более одного раза: экземпляр с данным именем останется в процессе навсегда. Поэтому после успешного прохождения теста Afina придётся остановить, второй раз тест она не пройдёт.

### Как работает

Используются только входящие в комплект Perl модули, но на CentOS7 придётся сделать `yum install perl-Test-Simple`.

Тест принимает параметры командной строки:

* `-a` / `--address=127.0.0.1` задаёт адрес, куда подключаться
* `-p` / `--port=8080` задаёт порт
* `-s` / `--silent` уменьшает количество отладочной информации (сетевой обмен данными будет спрятан)

Если запускать тест при помощи `prove` (рекомендуется: он старается печатать только ошибки и выводит краткую статистику), параметры необходимо отделять `::`. Пример:

    prove ../../afina/itest/network_test.pl :: -a 192.0.2.19 -p 11211

Если запускать тест напрямую при помощи `perl`, двоеточия не нужны. Если TAP-драйвер не позволяет передавать аргументы командной строки, можно назначить переменные окружения `AFINA_SERVER` и `AFINA_PORT`.

### У меня не проходит тесты

Тесты - это код. Код часто содержит ошибки. Ergo, тесты могут содержать ошибки. Тем не менее,

#### Ошибка может быть не только в сетевом слое

Если тест говорит, что должно быть `NOT_STORED`, а Afina вернула `STORED`, дело, скорее всего, в `MapBasedGlobalLockImpl.cpp` или его окрестностях. Убедитесь при помощи отладчика.

#### Начинаем с первого заваленного теста

Некоторые тесты зависимы друг от друга. Например, один тест сначала создаёт запись в базе, затем второй дописывает к ней ещё немного, а третий проверяет, что дописанное значение совпадает с ожидаемым.

#### На чём именно упало?

Разберём пример:

    #   Failed test 'Replace an existent key'
    #   at ../itest/t.pl line 86.
    #          got: 'CLIENT_ERROR Unknown command name
    # '
    #     expected: 'STORED
    # '

Здесь видно название теста ("Replace an existent key"), ожидаемое значение ответа Afina на команду и то, что нам ответили вместо этого. Если из названия теста не понятно, что не так, можно запустить `prove -v ...` (или напрямую `perl .../путь/к/тесту`) и посмотреть на сетевой ввод-вывод:

    ok 45 - Connected to Afina
    ok 46 - Sent request
    # -> replace test 0 0 3
    # -> zzz
    ok 47 - Closed writing end of connection
    # <- CLIENT_ERROR Unknown command name
    not ok 48 - Replace an existent key

Здесь видно, что `CLIENT_ERROR` нам прислали в ответ на команду `replace`. Отсюда уже можно делать выводы.

#### Looks like you planned XX tests but ran YY

Сам набор тестов может выбросить исключение и упасть. Например, так происходит, если `afina` падает, и очередная попытка подключиться к ней не удаётся. При этом оказывается запущено меньше тестов, чем планировалось.
