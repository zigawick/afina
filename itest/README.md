## `network_test.pl`

### TL;DR

    # yum install perl-Test-Simple
	$ prove .../путь/к/itest.pl

### Как работает

Используются только входящие в комплект Perl модули, но на CentOS7 придётся сделать `yum install perl-Test-Simple`.

Тест пытается найти Afina по следующим путям:

* `./afina`
* `./src/afina`
* `./*/src/afina` (во всех поддиреториях 1-го уровня ищет `src/afina`)
* находит директорию, в которой лежит сам (`репозиторий/itest`), и от уровня выше ищет `*/src/afina`

Первые 3 пункта позволяют запустить тест из любого места, находясь в консоли рядом с исполняемым файлом `afina`. Последний позволяет запустить тест, находясь в любом месте репозитория, но только своего.

Тест принимает параметры командной строки:

* `-a` / `--afina=путь/к/src/afina` позволяет передать путь к программе вручную, если тест её не находит или находит неправильно
* `-b` / `--backend=...` передаёт `afina` параметр `--network=...`, по умолчанию `blocking`
* `-s` / `--silent` уменьшает количество отладочной информации (сетевой обмен данными и stdout+stderr самой `afina` будут спрятаны)

Если запускать тест при помощи `prove` (рекомендуется: он старается печатать только ошибки и выводит краткую статистику), параметры необходимо отделять `::`. Пример:

    prove ../../afina/itest/network_test.pl :: -a ../build/src/afina

Если запускать тест напрямую при помощи `perl`, двоеточия не нужны. Если TAP-драйвер не позволяет передавать аргументы командной строки, можно назначить переменные окружения `AFINA_PATH` и `NETWORK_BACKEND`.

### У меня не проходит тесты

Тесты - это код. Код часто содержит ошибки. Ergo, тесты могут содержать ошибки. Тем не менее,

#### Начинаем с первого заваленного теста

Некоторые тесты зависимы друг от друга. Например, один тест сначала создаёт запись в базе, затем второй дописывает к ней ещё немного, а третий проверяет, что дописанное значение совпадает с ожидаемым.

#### На чём именно упало?

Разберём пример:

    #   Failed test 'Replace an existent key'
    #   at ../itest/t.pl line 86.
    #          got: 'CLIENT_ERROR Unknown command name
    # '
    #     expected: 'STORED
    # '

Здесь видно название теста ("Replace an existent key"), ожидаемое значение ответа Afina на команду и то, что нам ответили вместо этого. Если из названия теста не понятно, что не так, можно запустить `prove -v ...` (или напрямую `perl .../путь/к/тесту`) и посмотреть на сетевой ввод-вывод:

    ok 45 - Connected to Afina
    ok 46 - Sent request
    # -> replace test 0 0 3
    # -> zzz
    ok 47 - Closed writing end of connection
    # <- CLIENT_ERROR Unknown command name
    not ok 48 - Replace an existent key

Здесь видно, что `CLIENT_ERROR` нам прислали в ответ на команду `replace`. Отсюда уже можно делать выводы.

#### Ошибка может быть не только в сетевом слое

Если тест говорит, что должно быть `NOT_STORED`, а Afina вернула `STORED`, дело, скорее всего, в `MapBasedGlobalLockImpl.cpp` или его окрестностях.

#### Looks like you planned XX tests but ran YY

Сам набор тестов может выбросить исключение и упасть. Например, так происходит, если `afina` падает, и очередная попытка подключиться к ней не удаётся. При этом оказывается запущено меньше тестов, чем планировалось.

